x-environment: &shopware
  image: ghcr.io/shopwarelabs/example-docker-repository:latest@sha256:80115160231cb70cc9b9c11441f76c95278959cf812cae67fa452ee09621b541
  environment:
    APP_ENV: prod
    DATABASE_URL: ${DATABASE_URL:-mysql://shopware:shopware@database:3306/shopware}
    DATABASE_HOST: ${DATABASE_HOST:-database}
    APP_URL: ${APP_URL:-http://localhost:8000}
    APP_SECRET: ${APP_SECRET}
    JWT_PRIVATE_KEY: ${JWT_PRIVATE_KEY}
    JWT_PUBLIC_KEY: ${JWT_PUBLIC_KEY}
    PHP_SESSION_HANDLER: redis
    PHP_SESSION_SAVE_PATH: 'tcp://cache:6379/1'
    SERVICE_REGISTRY_URL: ${SERVICE_REGISTRY_URL}
  volumes:
    - files:/var/www/html/files
    - theme:/var/www/html/public/theme
    - media:/var/www/html/public/media
    - thumbnail:/var/www/html/public/thumbnail
    - sitemap:/var/www/html/public/sitemap

services:
  database:
    image: mariadb:11.4
    environment:
      MARIADB_ROOT_PASSWORD: ${MARIADB_ROOT_PASSWORD}
      MARIADB_USER: ${MARIADB_USER}
      MARIADB_PASSWORD: ${MARIADB_PASSWORD}
      MARIADB_DATABASE: ${MARIADB_DATABASE}
    tmpfs:
      - /var/lib/mysql
    healthcheck:
      test: [ "CMD", "mariadb-admin" ,"ping", "-h", "localhost", "-p${MARIADB_ROOT_PASSWORD}" ]
      timeout: 20s
      retries: 10
    networks:
      - shopware-network

  init-perm:
    image: alpine
    <<: *shopware
    command: chown 82:82 /var/www/html/files /var/www/html/public/theme /var/www/html/public/media /var/www/html/public/thumbnail /var/www/html/public/sitemap

  init:
    <<: *shopware
    entrypoint: /setup
    depends_on:
      database:
        condition: service_healthy
      init-perm:
        condition: service_completed_successfully

  web:
    <<: *shopware
    depends_on:
      init:
        condition: service_completed_successfully
    networks:
      - shopware-network

  worker:
    <<: *shopware
    restart: unless-stopped
    volumes_from:
      - init
    depends_on:
      init:
        condition: service_completed_successfully
    entrypoint: [ "php", "bin/console", "messenger:consume", "async low_priority", "--time-limit=300", "--memory-limit=512M" ]
    deploy:
      replicas: 3

  scheduled-task:
    <<: *shopware
    restart: unless-stopped
    volumes_from:
      - init
    depends_on:
      init:
        condition: service_completed_successfully
    entrypoint: [ "php", "bin/console", "scheduled-task:run" ]
  
  cache:
    image: valkey/valkey:latest
    networks:
      - shopware-network

      
volumes:
  mysql-data:
  files:
  theme:
  media:
  thumbnail:
  sitemap:

networks:
  shopware-network: